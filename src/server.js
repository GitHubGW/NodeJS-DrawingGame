import express from "express";
import { join } from "path"; // pathëª¨ë“ˆì„ ì‚¬ìš©í•˜ë©´ í´ë”ì™€ íŒŒì¼ì˜ ê²½ë¡œë¥¼ ì‰½ê²Œ ì¡°ìž‘í•  ìˆ˜ ìžˆë‹¤
import socketIO from "socket.io"; // WebSocketì„ ì‚¬ìš©í•˜ë ¤ë©´ socket.io íŒ¨í‚¤ì§€ê°€ í•„ìš”í•˜ë‹¤.
import morgan from "morgan";

const app = express();

const PORT = 4000;

// í…œí”Œë¦¿ ì—”ì§„ì˜ ê¸°ë³¸ ê²½ë¡œëŠ” root/viewsì´ë‹¤. (ê°€ìž¥ ìƒë‹¨ì— views)
// ë§Œì•½ ê²½ë¡œë¥¼ ë³€ê²½í–ˆì„ ë•ŒëŠ” ê°€ìž¥ ìƒë‹¨ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ì •í•´ì¤€ë‹¤.
app.set("views", "src/views");
app.set("view engine", "pug");

app.use(morgan("dev"));
// express.static()ì„ í†µí•´ expressê°€ ì •ì  íŒŒì¼(ì´ë¯¸ì§€ë‚˜ CSS, JSíŒŒì¼ ë“±)ì„ ì½ì–´ì˜¬ ìˆ˜ ìžˆëŠ” í´ë”ë¥¼ ë§Œë“¤ ìˆ˜ ìžˆë‹¤
app.use(express.static("src/static"));

app.get("/", (req, res) => {
  res.render("home.pug");
});

const handleListening = (req, res) => {
  console.log(`ðŸ˜€ Server running: http://localhost:${PORT}`);
};

const server = app.listen(PORT, handleListening);

// ìœ„ì—ì„œ ë§Œë“  ì›¹ ì„œë²„ë¥¼ serverë¼ëŠ” ë³€ìˆ˜ì— ë„£ì€ í›„ ê·¸ ë³€ìˆ˜ë¥¼ ê°€ì ¸ì™€ì„œ ì›¹ ì†Œì¼“ ì„œë²„ë¥¼ ë§Œë“¤ì—ˆë‹¤. (ioëŠ” ì†Œì¼“ ì„œë²„ì´ë‹¤.)
// ì†Œì¼“ ì„œë²„ë¥¼ ì˜ë¯¸í•˜ëŠ” ë³€ìˆ˜ ioë¥¼ ë§Œë“  ì´ìœ ëŠ” ì†Œì¼“ ì„œë²„ë¥¼ í†µí•´ ë‹¤ë¥¸ ì›¹ ì†Œì¼“ ì„œë²„ë“¤ê³¼ í†µì‹ í•˜ê³  ì´ë²¤íŠ¸ë¥¼ ì»¨íŠ¸ë¡¤í•˜ê¸° ìœ„í•´ì„œì´ë‹¤.
const io = socketIO(server);

// ì›¹ ì†Œì¼“ ì„œë²„ëŠ” connectionì´ë¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ë“£ê³  ìžˆë‹¤ê°€ connection ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•œë‹¤.
// ì½œë°± í•¨ìˆ˜ëŠ” íŒŒë¼ë¯¸í„°ë¡œ "ë°©ê¸ˆ ì—°ê²°ëœ ì†Œì¼“"ì„ ê°ì²´ë¡œ ê°€ì ¸ì˜¨ë‹¤.
// ì—¬ê¸° connection ë¶€ë¶„ì´ socketIoì˜ ì‹œìž‘ì ì´ë‹¤.
// socketê°ì²´ëŠ” expressìœ„ì—ì„œ ë³´ë‚´ëŠ” HTTPìš”ì²­ê³¼ ë¹„ìŠ·í•˜ë‹¤. ì†Œì¼“ì€ ì–´ë–¤ ìš”ì²­ì´ë‚˜ ì‘ë‹µì„ ë°›ê³  requestë¥¼ ì½˜ì†”ì— ë³´ì—¬ì¤„ ìˆ˜ ìžˆë‹¤.
// ê¸°íƒ€ ìƒì‹: ì´ ë¶€ë¶„ì€ ì„œë²„ì˜ ë©”ëª¨ë¦¬ ë¶€ë¶„ì´ë‹¤. ê·¸ëž˜ì„œ ë§Œì•½ ìˆ˜ì •ì„ í•˜ë©´ nodemonì´ ìžë™ìœ¼ë¡œ ì„œë²„ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ê²Œ ë˜ê³  ê·¸ëŸ¬ë©´ ì†Œì¼“ì˜ ë©”ëª¨ë¦¬ê°€ ë‚ ì•„ê°€ê²Œ ëœë‹¤.
// ê·¸ëž˜ì„œ ì†Œì¼“ì´ ì‹¤í–‰ë˜ë©´ì„œ ì €ìž¥í•˜ê³  ìžˆë˜ ì •ë³´ê°€ ë‚ ì•„ê°€ë²„ë¦°ë‹¤. ê·¸ëž˜ì„œ ì •ë³´ê°€ ë‚ ì•„ê°€ì§€ ì•Šê³  ê³„ì† ë‚¨ì•„ìžˆê²Œ í•˜ë ¤ë©´ ë°ì´í„°ë² ì´ìŠ¤ê°€ í•„ìš”í•œ ê²ƒì´ë‹¤.
io.on("connection", (socket) => {
  // socketì— ì—°ê²°ì´ ë˜ë©´ socketê°ì²´ ì•ˆì— ìžˆëŠ” ì—¬ëŸ¬ í”„ë¡œí¼í‹°ë“¤ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìžˆë‹¤. (ex: socket.id ë“±ë“±) (ì†Œì¼“ì€ idê°’ì´ ë‹¤ ë‹¬ë¼ì„œ ì´ê²ƒìœ¼ë¡œ ì†Œì¼“ë“¤ì„ êµ¬ë¶„í•  ìˆ˜ ìžˆë‹¤.)
  // console.log(socket.id);
  // ë°©ê¸ˆ ì—°ê²°ëœ(ì ‘ì†í•œ) ì†Œì¼“ì—ê²Œ emit()í•¨ìˆ˜ë¥¼ í†µí•´ "hello"ë¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ë³´ë‚¸ë‹¤(ë°œìƒì‹œí‚¨ë‹¤)
  // ì—¬ê¸°ì„œ ë³´ë‚¸ helloë¼ëŠ” ì´ë²¤íŠ¸ëŠ” í´ë¼ì´ì–¸íŠ¸(index.js)ë¡œ ê°€ê²Œ ë˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ hello ì´ë²¤íŠ¸ë¥¼ ë“¤ì–´ì•¼ í†µì‹ í•  ìˆ˜ ìžˆë‹¤.
  // socket.emit("hello");
  // broadcastëŠ” ë°©ê¸ˆ ì—°ê²°ëœ(ì ‘ì†í•œ) í´ë¼ì´ì–¸íŠ¸ ì†Œì¼“ì„ ì œì™¸í•˜ê³  ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ í†µì‹ ì„ ë³´ë‚¸ë‹¤
  // socket.broadcast.emit("hello");
  // ë°©ê¸ˆ ì—°ê²°ëœ(ì ‘ì†í•œ) ì†Œì¼“ìœ¼ë¡œë¶€í„° hello2ë¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ë“£ê³  ìžˆë‹¤ê°€ ì´ë²¤íŠ¸ê°€ ì˜¤ë©´ ì½œë°±í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•¨
  // socket.on("hello2", () => console.log("I listened hello2"));

  // ì—°ê²°ëœ socketìœ¼ë¡œë¶€í„° newMessageë¼ëŠ” ì´ë²¤íŠ¸ë¥¼ ë“£ëŠ”ë‹¤.
  // ì´ë²¤íŠ¸ì— ì—°ê²°ë˜ë©´ ì½œë°±í•¨ìˆ˜ëŠ” ì´ë²¤íŠ¸ì™€ í•¨ê»˜ ì •ë³´ê°€ ë“¤ì–´ìžˆëŠ” messageê°ì²´ë¥¼ ë°›ì„ ìˆ˜ ìžˆë‹¤
  // í•¨ìˆ˜ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì„ ë•Œ {message: message}ë¥¼ {message}í˜•íƒœë¡œ ë°›ê²Œ ë˜ë©´ messageí‚¤ì˜ ë²¨ë¥˜ê°’ì„ ì§ì ‘ ë°›ê²Œ ëœë‹¤.
  // socket.nickname || Anonymousì˜ ì˜ë¯¸ëŠ” ì•žì— socket.nicknameì´ ì—†ë‹¤ë©´ ë’¤ì— Anonymousë¡œ ê°’ì„ ì²˜ë¦¬í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.
  socket.on("newMessage", ({ message }) => {
    // console.log("message", message);
    socket.broadcast.emit("messageNotify", { message: message, nickname: socket.nickname || "Anonymous" });
  });

  socket.on("setNickname", ({ nickname }) => {
    // console.log("nickname", nickname);
    socket.nickname = nickname;
  });
});
